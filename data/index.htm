<!DOCTYPE html>
<html>

<head>
	<meta name="viewport" content="width=device-width, initial-scale=1.0" />		
	<title>Sous Vide Control</title>
	<script src="jquery-3.2.1.min.js"></script>
	<script>
		var tRefresh = 0;
		var rx = false;

		$(document).ready(function () {
			setInterval(function () {
				$('#tRefresh').html("Last updated " + (tRefresh++) + " seconds ago").css('color', (tRefresh > 10 && (tRefresh % 2 == 0) ? 'red' : 'black'));
			}, 1000);

			$('#setTempForm').submit(function (e) {
				e.preventDefault();
				$('#currentSetTemp').html("...");
				$.post("/io", $(this).serialize()).done(updateDisplay);
			});

			$('#offbutton').click(function () {
				$('#setTempForm')[0].reset();
				$.post("/io", { powerOff: 1 }).done(updateDisplay);
			});

			$.get("/io", updateDisplay);
			window.setInterval(function () {
				if(!rx) $.get("/io", updateDisplay).fail(function(){rx = false;});
				rx = true;
			}, 5000);

		});

		function updateDisplay(data) {
			rx = false;
			tRefresh = 0;
			$('#currentSetTemp').html(data.setTemp + "\xB0 F");
			$("#power").html(data.power);
			$("#temperature").html(data.temperature + "\xB0 F");
			$("#running").html(data.running ? "On" : "Off");
			var date = new Date(null);
			date.setSeconds(data.upTime / 1000);
			$("#upTime").html(date.toISOString().substr(11, 8));
		}
	</script>

	<link rel="stylesheet" type="text/css" href="style.css">

</head>

<body>

	<div id="main">
		Current Set Point: <span id="currentSetTemp"></span>
		<form id="setTempForm">
			<input type="number" name="setTemp" step=".1" min="0" max="400" />
			<input class="dbutton" type="submit" value="Set" />
			<button type="button" id="offbutton" class="dbutton">Off</button>
		</form>

		Current Temp: <span id="temperature"></span>
		<br> Power Level: <span id="power"></span>
		<br> Running: <span id="running"></span>
		<br> Time @ Temp: <span id="upTime"></span>
		<br><span class="smalltext" id="tRefresh"></span>
		<br>
		<br>
		<div id="nav">
			<a href="/" class="dbutton">Home</a>
			<br>
			<a href="graph.htm" class="dbutton">Graph</a>
			<br>
			<a href="recipes.htm" class="dbutton">Recipes</a>
			<br>
			<a href="wifi.htm" class="dbutton">WiFi Setup</a>
		</div>
	</div>


</body>

</html>